<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>جستجوی کتاب‌های خطی فارسی</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3"></script>
  <style>
    body {
      font-family: sans-serif;
    }
    @media (prefers-color-scheme: dark) {
      html {
        color-scheme: dark;
      }
      body {
        background-color: #1f2937;
        color: white;
      }
    }
  </style>
</head>
<body>
  <div id="app" class="p-6 max-w-7xl mx-auto" dir="rtl">
    <h1 class="text-3xl font-bold mb-6 text-center">جستجوی کتاب‌های خطی فارسی</h1>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">

      <div class="md:col-span-1 bg-white dark:bg-gray-800 p-4 rounded-lg shadow text-sm space-y-6">
        <div>
          <h2 class="font-bold mb-2">پدیدآورندگان پرتکرار</h2>
          <ul>
            <li v-for="([author, count], i) in topAuthors" :key="i" class="cursor-pointer hover:text-blue-600"
                @click="filters.author = author">
              {{ author }} ({{ toPersianDigits(count) }})
            </li>
          </ul>
        </div>
        <div>
          <h2 class="font-bold mb-2">ناشران پرتکرار</h2>
          <ul>
            <li v-for="([pub, count], i) in topPublishers" :key="i" class="cursor-pointer hover:text-blue-600"
                @click="filters.publisher = pub">
              {{ pub }} ({{ toPersianDigits(count) }})
            </li>
          </ul>
        </div>
        <div>
          <h2 class="font-bold mb-2">انواع پرتکرار</h2>
          <ul>
            <li v-for="([type, count], i) in topTypes" :key="i" class="cursor-pointer hover:text-blue-600"
                @click="filters.type = type">
              {{ type }} ({{ toPersianDigits(count) }})
            </li>
          </ul>
        </div>
      </div>

      <div class="md:col-span-3">
        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow mb-4">
          <div class="flex flex-wrap items-center gap-2 mb-2">
            <input type="text" v-model="search" placeholder="جستجو..."
                   class="flex-grow p-2 border rounded focus:outline-none text-black">
            <select v-model="sortKey" class="p-2 border rounded">
              <option value="title">عنوان</option>
              <option value="author">پدیدآور</option>
              <option value="publisher">ناشر</option>
              <option value="type">نوع</option>
              <option value="date">تاریخ</option>
            </select>
            <select v-model="sortOrder" class="p-2 border rounded">
              <option value="asc">صعودی</option>
              <option value="desc">نزولی</option>
            </select>
            <button @click="resetFilters"
                    class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">پاک‌سازی</button>
          </div>
          <p class="text-gray-700 dark:text-gray-300">
            نمایش {{ toPersianDigits(filteredBooks.length) }} نتیجه از {{ toPersianDigits(books.length) }}
          </p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div v-for="(book, i) in filteredBooks" :key="book.catid || i"
               class="bg-white dark:bg-gray-900 p-4 rounded-lg shadow border">
            <h2 class="font-bold text-blue-700 text-lg mb-1">{{ book.title }}</h2>
            <p v-if="book.author" class="mb-1">پدیدآور: {{ book.author }}</p>
            <p v-if="book.publisher" class="mb-1">ناشر: {{ book.publisher }}</p>
            <p v-if="book.type" class="mb-1">نوع: {{ book.type }}</p>
            <p v-if="book.date" class="mb-1">تاریخ: {{ book.date }}</p>
            <p v-if="book.id" class="mb-1">شماره راهنما: {{ book.id }}</p>
            <p v-if="book.catid" class="mb-1">
              <a :href="`https://lib.ut.ac.ir/site/catalogue/${book.catid}`" target="_blank"
                 class="text-blue-600 hover:underline">لینک کاتالوگ</a>
            </p>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script>
    const { createApp } = Vue;
    createApp({
      data() {
        return {
          books: [],
          search: '',
          sortKey: 'title',
          sortOrder: 'asc',
          filters: {
            author: null,
            publisher: null,
            type: null
          }
        }
      },
      computed: {
        filteredBooks() {
          let result = this.books.filter(b => {
            const term = this.search.toLowerCase();
            return (!this.filters.author || b.author === this.filters.author) &&
                   (!this.filters.publisher || b.publisher === this.filters.publisher) &&
                   (!this.filters.type || b.type === this.filters.type) &&
                   (b.title?.toLowerCase().includes(term) ||
                    b.author?.toLowerCase().includes(term) ||
                    b.id?.toLowerCase().includes(term));
          });

          result.sort((a, b) => {
            let valA = (a[this.sortKey] || '').toString().toLowerCase();
            let valB = (b[this.sortKey] || '').toString().toLowerCase();
            return this.sortOrder === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
          });

          return result;
        },
        topAuthors() {
          return this.getTopCounts('author', 5);
        },
        topPublishers() {
          return this.getTopCounts('publisher', 5);
        },
        topTypes() {
          return this.getTopCounts('type', 5);
        }
      },
      methods: {
        async fetchBooks() {
          const res = await fetch('./utlibrary-manuscripts.json');
          this.books = await res.json();
        },
        resetFilters() {
          this.search = '';
          this.sortKey = 'title';
          this.sortOrder = 'asc';
          this.filters = { author: null, publisher: null, type: null };
        },
        getTopCounts(key, min = 1) {
          const counts = {};
          this.books.forEach(b => {
            const val = b[key];
            if (val) counts[val] = (counts[val] || 0) + 1;
          });
          return Object.entries(counts).filter(([, c]) => c >= min).sort((a, b) => b[1] - a[1]);
        },
        toPersianDigits(str) {
          return String(str).replace(/\d/g, d => '۰۱۲۳۴۵۶۷۸۹'[d]);
        }
      },
      mounted() {
        this.fetchBooks();
      }
    }).mount('#app')
  </script>
</body>
</html>
