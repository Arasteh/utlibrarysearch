<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>جستجوی کتاب‌های خطی فارسی</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* حذف فونت Inter و اتکا به فونت‌های سیستم */
    body {
      font-family: sans-serif; /* استفاده از فونت‌های پیش‌فرض سیستم */
      background-color: #f9fafb;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <script type="text/javascript">
    const { useState, useEffect } = React;

    const App = () => {
      const [books, setBooks] = useState([]);
      const [searchTerm, setSearchTerm] = useState('');
      const [filteredBooks, setFilteredBooks] = useState([]);
      const [selectedType, setSelectedType] = useState('همه');
      const [selectedDb, setSelectedDb] = useState('همه');
      const [types, setTypes] = useState([]);
      const [dbs, setDbs] = useState([]);
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        const fetchData = async () => {
          setLoading(true);
          try {
            const response = await fetch('./utlibrary-manuscripts.json');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            setBooks(data);

            const uniqueTypes = [...new Set(data.map(book => book.type))].sort();
            const uniqueDbs = [...new Set(data.map(book => book.db))].sort();
            setTypes(['همه', ...uniqueTypes]);
            setDbs(['همه', ...uniqueDbs]);
          } catch (error) {
            console.error('خطا در بارگذاری داده‌ها:', error);
          } finally {
            setLoading(false);
          }
        };

        fetchData();
      }, []);

      // فیلتر کردن نتایج بر اساس searchTerm و فیلترهای کشویی
      useEffect(() => {
        console.log('useEffect فیلتر در حال اجرا. عبارت جستجو:', searchTerm);

        let currentFiltered = [...books];

        const q = searchTerm.toLowerCase().trim();

        // اگر کادر جستجو خالی است، هیچ نتیجه‌ای نمایش نده
        if (q === '') {
            setFilteredBooks([]);
            console.log('عبارت جستجو خالی است. نتایج پاک شد.');
            return;
        }

        // اعمال فیلتر جستجو
        currentFiltered = currentFiltered.filter(book =>
          (book.title || '').toLowerCase().includes(q) ||
          (book.author || '').toLowerCase().includes(q) ||
          (book.id || '').toLowerCase().includes(q)
        );

        // اعمال فیلتر نوع
        if (selectedType !== 'همه') {
          currentFiltered = currentFiltered.filter(book => book.type === selectedType);
        }

        // اعمال فیلتر پایگاه داده
        if (selectedDb !== 'همه') {
          currentFiltered = currentFiltered.filter(book => book.db === selectedDb);
        }

        // مرتب‌سازی بر اساس catid
        currentFiltered.sort((a, b) => {
            const catidA = parseInt(a.catid, 10);
            const catidB = parseInt(b.catid, 10);
            if (isNaN(catidA) && isNaN(catidB)) return 0;
            if (isNaN(catidA)) return 1;
            if (isNaN(catidB)) return -1;
            return catidA - catidB;
        });

        setFilteredBooks(currentFiltered.slice(0, 200)); // محدودیت ۲۰۰ نتیجه
        console.log('نتایج فیلتر شده به‌روزرسانی شد. تعداد نتایج:', currentFiltered.slice(0, 200).length);
      }, [books, searchTerm, selectedType, selectedDb]); // وابستگی به searchTerm

      const handleSearchChange = (event) => {
        setSearchTerm(event.target.value);
      };

      const handleTypeChange = (event) => {
        setSelectedType(event.target.value);
      };

      const handleDbChange = (event) => {
        setSelectedDb(event.target.value);
      };

      const handleClearSearch = () => {
        setSearchTerm('');
        setSelectedType('همه'); // ریست کردن فیلتر نوع
        setSelectedDb('همه');   // ریست کردن فیلتر پایگاه داده
      };

      return React.createElement(
        'div',
        { className: 'p-6 max-w-5xl mx-auto', dir: 'rtl' },
        React.createElement('h1', { className: 'text-3xl font-bold mb-6 text-center text-gray-800' }, 'جستجوی کتاب‌های خطی فارسی'),
        React.createElement('div', { className: 'bg-white p-6 rounded-lg shadow mb-6' },
          React.createElement('div', { className: 'flex items-center mb-4' },
            React.createElement('input', {
              type: 'text',
              className: 'flex-grow p-3 border rounded-r-none rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out',
              placeholder: 'جستجو بر اساس عنوان، نویسنده یا شناسه...',
              value: searchTerm,
              onChange: handleSearchChange,
              dir: 'rtl'
            }),
            React.createElement('button', {
              onClick: handleClearSearch,
              className: 'bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-l-none rounded-lg transition duration-200 ease-in-out shadow-md'
            }, 'پاک کردن فیلترها')
          ),
          React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-4' },
            React.createElement('div', null,
              React.createElement('label', { className: 'block mb-1 text-gray-700 font-medium' }, 'نوع:'),
              React.createElement('select', {
                className: 'w-full p-2 border rounded',
                value: selectedType,
                onChange: handleTypeChange
              }, types.map(type => React.createElement('option', { key: type, value: type }, type)))
            ),
            React.createElement('div', null,
              React.createElement('label', { className: 'block mb-1 text-gray-700 font-medium' }, 'مرکز:'),
              React.createElement('select', {
                className: 'w-full p-2 border rounded',
                value: selectedDb,
                onChange: handleDbChange
              }, dbs.map(db => React.createElement('option', { key: db, value: db }, db)))
            )
          )
        ),
        loading
          ? React.createElement('div', { className: 'text-center text-gray-600 text-lg' }, 'در حال بارگذاری...')
          : React.createElement('div', {
              key: `${searchTerm}-${selectedType}-${selectedDb}`, // کلید پویا برای اجبار به رندر مجدد
              className: 'grid grid-cols-1 md:grid-cols-2 gap-4'
            },
              filteredBooks.length > 0
                ? filteredBooks.map((book, index) =>
                  React.createElement('div', {
                    key: book.id || index,
                    className: 'bg-white p-4 rounded-lg shadow border'
                  },
                    React.createElement('h2', { className: 'font-bold text-blue-700 mb-2 text-xl' }, book.title),
                    React.createElement('p', { className: 'text-gray-800 mb-1' }, 'پدیدآور: ' + (book.author || '')),
                    React.createElement('p', { className: 'text-gray-800 mb-1' }, 'تاریخ انتشار: ' + (book.date || '')),
                    React.createElement('p', { className: 'text-gray-800 mb-1' }, 'مرکز: ' + (book.db || '')),
                    React.createElement('p', { className: 'text-gray-800 mb-1' }, 'نوع: ' + (book.type || '')),
                    book.catid && React.createElement('p', { className: 'text-gray-800' },
                        React.createElement('span', { className: 'font-medium' }, 'شماره راهنما:'),
                        ' ',
                        book.id,
                        React.createElement('span', { className: 'font-medium mr-2' }, ' | لینک کاتالوگ:'),
                        ' ',
                        React.createElement(
                            'a',
                            {
                                href: `https://lib.ut.ac.ir/site/catalogue/${book.catid}`,
                                target: '_blank',
                                rel: 'noopener noreferrer',
                                className: 'text-blue-600 hover:underline'
                            },
                            book.catid
                        )
                    )
                  )
                )
                : React.createElement('div', { className: 'col-span-full text-center text-gray-600 text-xl p-8' },
                    searchTerm.trim() === ''
                      ? 'برای شروع جستجو، عبارت مورد نظر را وارد کنید.'
                      : 'نتیجه‌ای یافت نشد.'
                  )
            )
      );
    };

    const container = document.getElementById('root');
    const root = ReactDOM.createRoot(container);
    root.render(React.createElement(App));
  </script>
</body>
</html>
