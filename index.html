<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>جستجوی کتاب‌های خطی فارسی</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f9fafb;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <script type="text/javascript">
    const { useState, useEffect, useRef } = React; // Added useRef

    const App = () => {
      const [books, setBooks] = useState([]);
      const [searchTerm, setSearchTerm] = useState('');
      const [debouncedSearchTerm, setDebouncedSearchTerm] = useState(''); // State for debounced term
      const [filteredBooks, setFilteredBooks] = useState([]);
      const [selectedType, setSelectedType] = useState('همه');
      const [selectedDb, setSelectedDb] = useState('همه');
      const [types, setTypes] = useState([]);
      const [dbs, setDbs] = useState([]);
      const [loading, setLoading] = useState(true);

      const timerRef = useRef(null); // Ref to hold the timeout ID for debounce

      useEffect(() => {
        const fetchData = async () => {
          setLoading(true);
          try {
            const response = await fetch('./utlibrary-manuscripts.json'); // Corrected path as per user's instruction
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            setBooks(data);

            const uniqueTypes = [...new Set(data.map(book => book.type))].sort();
            const uniqueDbs = [...new Set(data.map(book => book.db))].sort();
            setTypes(['همه', ...uniqueTypes]);
            setDbs(['همه', ...uniqueDbs]);
          } catch (error) {
            console.error('خطا در بارگذاری داده‌ها:', error);
          } finally {
            setLoading(false);
          }
        };

        fetchData();
      }, []);

      // Debounce effect for search term
      useEffect(() => {
        // Clear any existing timer
        if (timerRef.current) {
          clearTimeout(timerRef.current);
        }

        // Set a new timer
        timerRef.current = setTimeout(() => {
          setDebouncedSearchTerm(searchTerm);
        }, 300); // 300ms delay

        // Cleanup function: clear the timer if searchTerm changes before the delay
        return () => {
          if (timerRef.current) {
            clearTimeout(timerRef.current);
          }
        };
      }, [searchTerm]); // Re-run this effect whenever searchTerm changes

      // Filtering effect, dependent on debouncedSearchTerm and other filters
      useEffect(() => {
        let currentFiltered = [...books]; // Start with all books

        const q = debouncedSearchTerm.toLowerCase().trim();

        // Apply search filtering only if debouncedSearchTerm has at least 2 characters
        if (q.length >= 2) {
          currentFiltered = currentFiltered.filter(book =>
            (book.title || '').toLowerCase().includes(q) ||
            (book.author || '').toLowerCase().includes(q) ||
            (book.id || '').toLowerCase().includes(q)
          );
        } else {
          currentFiltered = []; // If search term is too short or empty, show no results
        }

        // Apply type filter
        if (selectedType !== 'همه') {
          currentFiltered = currentFiltered.filter(book => book.type === selectedType);
        }

        // Apply database filter
        if (selectedDb !== 'همه') {
          currentFiltered = currentFiltered.filter(book => book.db === selectedDb);
        }

        // Sort by catid
        currentFiltered.sort((a, b) => {
            const catidA = parseInt(a.catid, 10);
            const catidB = parseInt(b.catid, 10);
            // Handle cases where catid might not be a valid number
            if (isNaN(catidA) && isNaN(catidB)) return 0;
            if (isNaN(catidA)) return 1; // Push non-numeric catid to end
            if (isNaN(catidB)) return -1; // Push non-numeric catid to end
            return catidA - catidB;
        });

        setFilteredBooks(currentFiltered.slice(0, 200)); // Limit to 200 results
      }, [books, debouncedSearchTerm, selectedType, selectedDb]); // Dependencies include debouncedSearchTerm

      return React.createElement(
        'div',
        { className: 'p-6 max-w-5xl mx-auto', dir: 'rtl' },
        React.createElement('h1', { className: 'text-3xl font-bold mb-6 text-center text-gray-800' }, 'جستجوی کتاب‌های خطی فارسی'),
        React.createElement('div', { className: 'bg-white p-6 rounded-lg shadow mb-6' },
          React.createElement('input', {
            type: 'text',
            className: 'w-full mb-4 p-3 border rounded text-lg',
            placeholder: 'جستجو بر اساس عنوان، نویسنده یا شناسه...', // Updated placeholder
            value: searchTerm,
            onChange: e => setSearchTerm(e.target.value),
            dir: 'rtl'
          }),
          React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-4' },
            React.createElement('div', null,
              React.createElement('label', { className: 'block mb-1 text-gray-700 font-medium' }, 'نوع:'),
              React.createElement('select', {
                className: 'w-full p-2 border rounded',
                value: selectedType,
                onChange: e => setSelectedType(e.target.value)
              }, types.map(type => React.createElement('option', { key: type, value: type }, type)))
            ),
            React.createElement('div', null,
              React.createElement('label', { className: 'block mb-1 text-gray-700 font-medium' }, 'مرکز:'),
              React.createElement('select', {
                className: 'w-full p-2 border rounded',
                value: selectedDb,
                onChange: e => setSelectedDb(e.target.value)
              }, dbs.map(db => React.createElement('option', { key: db, value: db }, db)))
            )
          )
        ),
        loading
          ? React.createElement('div', { className: 'text-center text-gray-600 text-lg' }, 'در حال بارگذاری...')
          : React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-4' },
              filteredBooks.length > 0
                ? filteredBooks.map((book, index) =>
                  React.createElement('div', {
                    key: book.id || index, // Use book.id as key if available, otherwise index
                    className: 'bg-white p-4 rounded-lg shadow border'
                  },
                    React.createElement('h2', { className: 'font-bold text-blue-700 mb-2 text-xl' }, book.title),
                    React.createElement('p', { className: 'text-gray-800 mb-1' }, 'پدیدآور: ' + (book.author || '')),
                    React.createElement('p', { className: 'text-gray-800 mb-1' }, 'تاریخ انتشار: ' + (book.date || '')), // Added date back
                    React.createElement('p', { className: 'text-gray-800 mb-1' }, 'مرکز: ' + (book.db || '')),
                    React.createElement('p', { className: 'text-gray-800 mb-1' }, 'نوع: ' + (book.type || '')),
                    book.catid && React.createElement('p', { className: 'text-gray-800' }, // Combined ID and link
                        React.createElement('span', { className: 'font-medium' }, 'شماره راهنما:'),
                        ' ',
                        book.id,
                        React.createElement('span', { className: 'font-medium mr-2' }, ' | لینک کاتالوگ:'),
                        ' ',
                        React.createElement(
                            'a',
                            {
                                href: `https://lib.ut.ac.ir/site/catalogue/${book.catid}`,
                                target: '_blank',
                                rel: 'noopener noreferrer',
                                className: 'text-blue-600 hover:underline'
                            },
                            book.catid
                        )
                    )
                  )
                )
                : React.createElement('div', { className: 'col-span-full text-center text-gray-600 text-xl p-8' },
                    debouncedSearchTerm.length < 2
                      ? 'برای شروع جستجو، حداقل ۲ حرف وارد کنید.'
                      : 'نتیجه‌ای یافت نشد.'
                  )
            )
      );
    };

    const container = document.getElementById('root');
    const root = ReactDOM.createRoot(container);
    root.render(React.createElement(App));
  </script>
</body>
</html>
