<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>جستجوی کتاب‌های خطی فارسی</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: sans-serif;
      background-color: #f9fafb;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <script type="text/javascript">
    const { useState, useEffect } = React;

    const App = () => {
      const [books, setBooks] = useState([]);
      const [searchTerm, setSearchTerm] = useState('');
      const [filteredBooks, setFilteredBooks] = useState([]);
      const [loading, setLoading] = useState(true);
      const [sortByKey, setSortByKey] = useState('catid'); // Default sort by catid
      const [sortOrder, setSortOrder] = useState('asc'); // Default ascending

      useEffect(() => {
        const fetchData = async () => {
          setLoading(true);
          try {
            const response = await fetch('./utlibrary-manuscripts.json');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            setBooks(data);
          } catch (error) {
            console.error('خطا در بارگذاری داده‌ها:', error);
          } finally {
            setLoading(false);
          }
        };

        fetchData();
      }, []);

      useEffect(() => {
        let currentFiltered = [...books];

        const q = searchTerm.toLowerCase().trim();

        // اگر کادر جستجو خالی است، هیچ نتیجه‌ای نمایش نده
        if (q === '') {
            setFilteredBooks([]);
            return;
        }

        // اعمال فیلتر جستجو
        currentFiltered = currentFiltered.filter(book =>
          (book.title || '').toLowerCase().includes(q) ||
          (book.author || '').toLowerCase().includes(q) ||
          (book.id || '').toLowerCase().includes(q)
        );

        // مرتب‌سازی نتایج
        currentFiltered.sort((a, b) => {
            let valA, valB;

            switch (sortByKey) {
                case 'author':
                    valA = (a.author || '').toLowerCase();
                    valB = (b.author || '').toLowerCase();
                    break;
                case 'date':
                    valA = (a.date || '').toLowerCase(); // Treat date as string for sorting
                    valB = (b.date || '').toLowerCase();
                    break;
                case 'id':
                    valA = parseInt(a.id, 10) || 0;
                    valB = parseInt(b.id, 10) || 0;
                    break;
                case 'catid':
                    valA = parseInt(a.catid, 10) || 0;
                    valB = parseInt(b.catid, 10) || 0;
                    break;
                case 'title':
                default:
                    valA = (a.title || '').toLowerCase();
                    valB = (b.title || '').toLowerCase();
                    break;
            }

            if (typeof valA === 'number' && typeof valB === 'number') {
                return sortOrder === 'asc' ? valA - valB : valB - valA;
            } else {
                const comparison = valA.localeCompare(valB, 'fa', { sensitivity: 'base' });
                return sortOrder === 'asc' ? comparison : -comparison;
            }
        });

        setFilteredBooks(currentFiltered.slice(0, 200)); // محدودیت ۲۰۰ نتیجه
      }, [books, searchTerm, sortByKey, sortOrder]); // وابستگی به searchTerm و sort states

      const handleSearchChange = (event) => {
        setSearchTerm(event.target.value);
      };

      const handleClearSearch = () => {
        setSearchTerm('');
        setSortByKey('catid'); // ریست کردن مرتب‌سازی به حالت پیش‌فرض
        setSortOrder('asc');
      };

      const handleSortOrderToggle = () => {
        setSortOrder(prevOrder => prevOrder === 'asc' ? 'desc' : 'asc');
      };

      return React.createElement(
        'div',
        { className: 'p-6 max-w-5xl mx-auto', dir: 'rtl' },
        React.createElement('h1', { className: 'text-3xl font-bold mb-6 text-center text-gray-800' }, 'جستجوی کتاب‌های خطی فارسی'),
        React.createElement('div', { className: 'bg-white p-6 rounded-lg shadow mb-6' },
          React.createElement('div', { className: 'flex items-center mb-4' },
            React.createElement('input', {
              type: 'text',
              className: 'flex-grow p-3 border rounded-r-none rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200 ease-in-out',
              placeholder: 'جستجو بر اساس عنوان، پدیدآور یا شماره راهنما...',
              value: searchTerm,
              onChange: handleSearchChange,
              dir: 'rtl'
            }),
            React.createElement('button', {
              onClick: handleClearSearch,
              className: 'bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-l-none rounded-lg transition duration-200 ease-in-out shadow-md'
            }, 'پاک کردن')
          ),
          React.createElement('div', { className: 'flex flex-wrap gap-2 mb-4 justify-center' },
            React.createElement('button', {
                onClick: () => setSortByKey('title'),
                className: `px-4 py-2 rounded-lg ${sortByKey === 'title' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-800'} hover:bg-blue-500 hover:text-white transition`
            }, 'مرتب‌سازی: عنوان'),
            React.createElement('button', {
                onClick: () => setSortByKey('author'),
                className: `px-4 py-2 rounded-lg ${sortByKey === 'author' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-800'} hover:bg-blue-500 hover:text-white transition`
            }, 'مرتب‌سازی: پدیدآور'),
            React.createElement('button', {
                onClick: () => setSortByKey('date'),
                className: `px-4 py-2 rounded-lg ${sortByKey === 'date' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-800'} hover:bg-blue-500 hover:text-white transition`
            }, 'مرتب‌سازی: تاریخ'),
            React.createElement('button', {
                onClick: () => setSortByKey('id'),
                className: `px-4 py-2 rounded-lg ${sortByKey === 'id' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-800'} hover:bg-blue-500 hover:text-white transition`
            }, 'مرتب‌سازی: شماره راهنما'),
            React.createElement('button', {
                onClick: () => setSortByKey('catid'),
                className: `px-4 py-2 rounded-lg ${sortByKey === 'catid' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-800'} hover:bg-blue-500 hover:text-white transition`
            }, 'مرتب‌سازی: آی‌دی کاتالوگ'),
            React.createElement('button', {
                onClick: handleSortOrderToggle,
                className: 'px-4 py-2 rounded-lg bg-purple-500 text-white hover:bg-purple-600 transition shadow-md'
            }, sortOrder === 'asc' ? 'ترتیب: صعودی' : 'ترتیب: نزولی')
          )
        ),
        loading
          ? React.createElement('div', { className: 'text-center text-gray-600 text-lg' }, 'در حال بارگذاری...')
          : React.createElement(
              'div',
              { className: 'mb-4 text-gray-700 text-lg font-medium text-center' },
              filteredBooks.length > 0
                ? `تعداد نتایج یافت شده: ${filteredBooks.length}`
                : ''
            ),
          React.createElement('div', {
              key: `${searchTerm}-${sortByKey}-${sortOrder}`, // کلید پویا برای اجبار به رندر مجدد
              className: 'grid grid-cols-1 md:grid-cols-2 gap-4'
            },
              filteredBooks.length > 0
                ? filteredBooks.map((book, index) =>
                  React.createElement('div', {
                    key: book.id || index,
                    className: 'bg-white p-4 rounded-lg shadow border'
                  },
                    React.createElement('h2', { className: 'font-bold text-blue-700 mb-2 text-xl' }, book.title),
                    React.createElement('p', { className: 'text-gray-800 mb-1' }, 'پدیدآور: ' + (book.author || '')),
                    React.createElement('p', { className: 'text-gray-800 mb-1' }, 'تاریخ انتشار: ' + (book.date || '')),
                    React.createElement('p', { className: 'text-gray-800 mb-1' }, 'مرکز: ' + (book.db || '')),
                    React.createElement('p', { className: 'text-gray-800 mb-1' }, 'نوع: ' + (book.type || '')),
                    book.catid && React.createElement('p', { className: 'text-gray-800' },
                        React.createElement('span', { className: 'font-medium' }, 'شماره راهنما:'),
                        ' ',
                        book.id,
                        React.createElement('span', { className: 'font-medium mr-2' }, ' | لینک کاتالوگ:'),
                        ' ',
                        React.createElement(
                            'a',
                            {
                                href: `https://lib.ut.ac.ir/site/catalogue/${book.catid}`,
                                target: '_blank',
                                rel: 'noopener noreferrer',
                                className: 'text-blue-600 hover:underline'
                            },
                            book.catid
                        )
                    )
                  )
                )
                : React.createElement('div', { className: 'col-span-full text-center text-gray-600 text-xl p-8' },
                    searchTerm.trim() === ''
                      ? 'برای شروع جستجو، عبارت مورد نظر را وارد کنید.'
                      : 'نتیجه‌ای یافت نشد.'
                  )
            )
      );
    };

    const container = document.getElementById('root');
    const root = ReactDOM.createRoot(container);
    root.render(React.createElement(App));
  </script>
</body>
</html>
